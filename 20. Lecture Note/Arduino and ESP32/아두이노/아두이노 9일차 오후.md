# 아두이노 9일차 오후

내일 시험 대비 공부

파이썬으로 시리얼 통신을 하는 방법은 여러가지가 있다.

![1.jpg](1%205.jpg)

```arduino
#include <Arduino.h>

const int encoderPin = 2; // 단일 디지털 엔코더 핀
volatile int encoderValue = 0;
volatile int lastState = LOW;
volatile int fakeValue = 0;

void setup() {
  Serial.begin(115200);
  pinMode(encoderPin, INPUT);
  
  // 인터럽트 설정
  attachInterrupt(digitalPinToInterrupt(encoderPin), updateEncoder, CHANGE);
  randomSeed(analogRead(0)); // 무작위 시드 설정
}

void loop() {
  // 엔코더 값과 가상의 값을 시리얼 포트를 통해 전송
  Serial.print(encoderValue);
  Serial.print(',');
  Serial.println(fakeValue); // 줄 바꿈을 추가하여 값의 끝을 표시
  delay(100); // 데이터를 주기적으로 전송
}

void updateEncoder() {
  int currentState = digitalRead(encoderPin);
  if (currentState != lastState) {
    if (currentState == HIGH) {
      encoderValue++;
    } else {
      encoderValue++;
    }
    fakeValue = random(0, 1000); // 엔코더 값이 변할 때마다 무작위 값 생성
    lastState = currentState;
  }
}
```

```python
import sys
import serial
from PyQt5.QtWidgets import QApplication, QMainWindow, QLabel, QVBoxLayout, QWidget
from PyQt5.QtCore import QTimer

class EncoderGUI(QMainWindow):
    def __init__(self):
        super().__init__()
        self.initUI()
        self.encoder_value = 0
        self.fake_value = 0

        # 시리얼 포트 설정
        self.ser = serial.Serial('COM6', 115200, timeout=1)  # COM 포트는 실제 사용하는 포트로 변경
        self.ser.flush()

        # 타이머 설정
        self.timer = QTimer()
        self.timer.timeout.connect(self.read_serial)
        self.timer.start(1)  # 100ms마다 데이터 읽기

    def initUI(self):
        self.setWindowTitle('Encoder Value Display')
        self.setGeometry(100, 100, 300, 200)
        
        self.encoder_label = QLabel('Encoder Value: 0', self)
        self.fake_label = QLabel('Fake Value: 0', self)
        layout = QVBoxLayout()
        layout.addWidget(self.encoder_label)
        layout.addWidget(self.fake_label)

        container = QWidget()
        container.setLayout(layout)
        self.setCentralWidget(container)

    def read_serial(self):
        if self.ser.in_waiting > 0:
            line = self.ser.readline().decode('utf-8').strip()
            if line:
                try:
                    values = line.split(',')
                    if len(values) == 2:
                        self.encoder_value = int(values[0])
                        self.fake_value = int(values[1])
                        self.encoder_label.setText(f'Encoder Value: {self.encoder_value}')
                        self.fake_label.setText(f'Fake Value: {self.fake_value}')
                except ValueError:
                    pass

    def closeEvent(self, event):
        self.ser.close()  # 시리얼 포트 닫기
        event.accept()

def main():
    app = QApplication(sys.argv)
    gui = EncoderGUI()
    gui.show()
    sys.exit(app.exec_())

if __name__ == '__main__':
    main()
```

# 이번엔 초음파 센서로 거리를 측정하고 일정 거리 밖에서는 버져를 울리는 코드

```arduino
#define TRIG_PIN 9
#define ECHO_PIN 10
#define BUZZER_PIN 8

void setup() {
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  
  Serial.begin(9600);
}

void loop() {
  long duration, distance;

  // 초음파 신호 전송
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  // Echo 핀으로부터 신호 수신
  duration = pulseIn(ECHO_PIN, HIGH);

  // 거리 계산 (음속: 340m/s = 29.1us/cm)
  distance = (duration / 2) / 29.1;

  // 거리 출력
  Serial.print("Distance: ");
  Serial.print(distance);
  Serial.println(" cm");

  // 거리가 10cm 이하일 때 버저 울림
  if (distance <= 10) {
    digitalWrite(BUZZER_PIN, HIGH);
  } else {
    digitalWrite(BUZZER_PIN, LOW);
  }

  delay(100); // 0.1초 대기
}
```

# 여기부터는 진도

잘 망가지는 ESP32에 웹서버가 달려 있어서 쉽게 접속 할 수 있는것

Station mode 와이파이로 연결해주는것(공유기 필요)

AP모드 라는 것이 훨신 좋은 수도 있다.(그 자체로 공유기가 되는 것)

어딘가 에서 공유기를 하나 가져와서 같이 연결하면 그게 Station mode이다.

그리고 라즈베리파이는 본인이 AP도 되고 Station도 된다.

그레서 이런 것 중에 가장 작은 것이 ESP32이다.

```python
/*MIT License

Copyright (c) 2024 JD edu. http://jdedu.kr author: conner.jeong@gmail.com
     
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
     
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
     
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN TH
SOFTWARE.*/
#include <WiFi.h>
#include <WebServer.h>

#define M1_B    26
#define M1_A    27

#define FORWARD   1
#define BACKWARD  2
#define STOP      3

/* Put your SSID & Password */
const char* ssid = "esp32_psy";  // Enter SSID here
const char* password = "123456789";  //Enter Password here

/* Put IP Address details */
IPAddress local_ip(192,168,1,1);
IPAddress gateway(192,168,1,1);
IPAddress subnet(255,255,255,0);

int motor_status = STOP;

WebServer server(80);

void go_forward(){
  Serial.println("forward");
  digitalWrite(M1_A, LOW);
  digitalWrite(M1_B, HIGH);
}

void go_backward(){
  Serial.println("backward");
  digitalWrite(M1_A, HIGH);
  digitalWrite(M1_B, LOW);
}

void stop(){
  Serial.println("stop");
  digitalWrite(M1_A, LOW);
  digitalWrite(M1_B, LOW);
  delay(200);
}

void setup() {
  Serial.begin(115200);

  pinMode(M1_A, OUTPUT);
  pinMode(M1_B, OUTPUT);
  stop();

  WiFi.softAP(ssid, password);
  WiFi.softAPConfig(local_ip, gateway, subnet);
  delay(100);
  
  server.on("/", handle_OnConnect);
  server.on("/forward", handle_forward);
  server.on("/backward", handle_backward);
  server.on("/stop", handle_stop);
  server.onNotFound(handle_NotFound);
  
  server.begin();
  Serial.println("HTTP server started");
}
void loop() {
  server.handleClient();
}

void handle_OnConnect() {
  stop();
  Serial.println("motor stop");
  server.send(200, "text/html", SendHTML(motor_status)); 
}

void handle_forward() {
  go_forward();
  motor_status = FORWARD;
  Serial.println("motor forward");
  server.send(200, "text/html", SendHTML(motor_status)); 
}

void handle_backward() {
  go_backward();
  motor_status = BACKWARD;
  Serial.println("motor backward");
  server.send(200, "text/html", SendHTML(motor_status)); 
}

void handle_stop() {
  stop();
  motor_status = STOP;
  Serial.println("motor stop");
  server.send(200, "text/html", SendHTML(motor_status)); 
}

void handle_NotFound(){
  server.send(404, "text/plain", "Not found");
}

String SendHTML(uint8_t motor_status){
  String ptr = "<!DOCTYPE html> <html>\n";
  ptr +="<head><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, user-scalable=no\">\n";
  ptr +="<title>LED Control</title>\n";
  ptr +="<style>html { font-family: Helvetica; display: inline-block; margin: 0px auto; text-align: center;}\n";
  ptr +="body{margin-top: 50px;} h1 {color: #444444;margin: 50px auto 30px;} h3 {color: #444444;margin-bottom: 50px;}\n";
  ptr +=".button {display: block;width: 80px;background-color: #3498db;border: none;color: white;padding: 13px 30px;text-decoration: none;font-size: 25px;margin: 0px auto 35px;cursor: pointer;border-radius: 4px;}\n";
  ptr +=".button-on {background-color: #3498db;}\n";
  ptr +=".button-on:active {background-color: #2980b9;}\n";
  ptr +=".button-off {background-color: #34495e;}\n";
  ptr +=".button-off:active {background-color: #2c3e50;}\n";
  ptr +="p {font-size: 14px;color: #888;margin-bottom: 10px;}\n";
  ptr +="</style>\n";
  ptr +="</head>\n";
  ptr +="<body>\n";
  ptr +="<h1>ESP32 Web Server</h1>\n";
  ptr +="<h3>Using Access Point(AP) Mode</h3>\n";

  switch(motor_status){
    case 1:
      {ptr +="<p>Motor forward</p><a class=\"button button-on\" href=\"/forward\">ON</a>\n";}
      {ptr +="<p>Motor backward</p><a class=\"button button-off\" href=\"/backward\">OFF</a>\n";}
      {ptr +="<p>stop</p><a class=\"button button-off\" href=\"/stop\">OFF</a>\n";}
      break;
    case 2:
      {ptr +="<p>Motor forward</p><a class=\"button button-off\" href=\"/forward\">OFF</a>\n";}
      {ptr +="<p>Motor backward</p><a class=\"button button-on\" href=\"/backward\">ON</a>\n";}
      {ptr +="<p>stop</p><a class=\"button button-off\" href=\"/stop\">OFF</a>\n";}
      break;
    case 3:
      {ptr +="<p>Motor forward</p><a class=\"button button-off\" href=\"/forward\">OFF</a>\n";}
      {ptr +="<p>Motor backward</p><a class=\"button button-off\" href=\"/backward\">OFF</a>\n";}
      {ptr +="<p>stop</p><a class=\"button button-on\" href=\"/stop\">ON</a>\n";}
      break;
  }
  ptr +="</body>\n";
  ptr +="</html>\n";
  return ptr;
}
```

![Untitled](Untitled%2070.png)

이 버튼을 누름에 따라 backward, forward, stop가 나온다

![Untitled](Untitled%2071.png)

아두이노 코드, 파이썬 코드, 동영상,