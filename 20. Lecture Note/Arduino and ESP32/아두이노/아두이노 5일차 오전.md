# 아두이노 5일차 오전

통신 방법 = RS-232 → 이건 컴퓨터와 컴퓨터를 연결하는 것이고

I2C같은 것들은 칩과칩을 연결하는 것이다. 

컴포트 내지는 시리얼 이라는 ic칩

이 친구가 내보내는 친구임

그런데 이 친구를 없애고 usb로 바꾸었다. 그런데 이 바꾸는 방식이 RS-232이다.

IC(CH) — Rs-232 —-IC(USB) — MCU

PC로 들어가려면 USB로 전환해서 들어가야하기에 아두이노에서 바로 연결하는 것은 불가능하다.

소프트웨어 시리얼을 봐야 한다.

테라텀은 아두이노의 시리얼 모니터와 같다.

# 통신 정리

큰 정리 

rs - 232와 rs-485는 일종의 통신방법이다. 이전에 USB가 없을 때 많이 사용하던 방식으로 485가 더 긴 선으로 통신을 할 때 많이 사용한다.

각각의 효율을 좋게 사용하는게 rs 232나 rs 485아고 우리는 이것을 PC로 받아서 보기 때문에 USB로 변환하는 것이다.

![Untitled](Untitled%2051.png)

아두이노에서 ROS로보낼떄

방법 1. 

127 3byte

방법2.

byte로

pcpic위에서 http에서 돌아간다.

http는 문자열로 왔다갔다 한다. passing도 문자열로 한다

그러나 pcpic는 아니다.

보통 로봇으로 통신하는 것은 http가 아닌 byte로 한다. 물론 문자열로도 가능하나 센서등이 많아지면 복잡해진다.

# 목표

우리는 지금까지 아두이노 시리얼 모니터에 직접 글자를 직접 쳤으나 원래 로봇은 자동화가 목적이다.

그러므로 오늘 우리는 파이썬에서 랜덤한 숫자 등을 발생시켜 a,b 사이에 넣어서 아두이노에 연결 해서 tera term에 출력 시키는 것을 하려고 하다.

vscode를 사용하려면 Serial을 보내야 한다.

또한 시리얼 모니터는 하나밖에 없으므로 시리얼 모니터를 끄고 진행해야 한다.

```python
import serial
import time
import random

# 시리얼 포트와 보드레이트 설정
arduino_port = 'COM5' 
baud_rate = 9600  # 아두이노와 일치하는 보드레이트 설정

# 시리얼 포트 열기
ser = serial.Serial(arduino_port, baud_rate, timeout=1)
time.sleep(2)  # 포트가 열릴 때까지 잠시 대기

def send_string_to_arduino(string):
    try:
        # 문자열을 바이트로 인코딩하여 전송
        ser.write(string.encode())
        print(f"Sent: {string}")
    except Exception as e:
        print(f"Error: {e}")

while True:
    uga = str(random.randint(1, 500))
    str_uga = "a" + uga + "b \n"

    # 문자열 전송
    send_string_to_arduino(str_uga)
    
    text = input("Continue?(y or n)")
    
    if text == 'n':
        break

# 시리얼 포트 닫기
ser.close()
```

```arduino
#include <SoftwareSerial.h>
SoftwareSerial mySerial(10, 11);// Rx, Tx

void setup() {
  mySerial.begin(9600);
  Serial.begin(9600);
  // put your setup code here, to run once:
}

void loop() {
  // mySerial.println("Hello from Arduino");
  if (Serial.available() > 0) {
    String uga = Serial.readStringUntil('\n');
    int start = uga.indexOf('a');
    int end = uga.indexOf('b');
    // substring 하기
    String sub_uga = uga.substring(start+1, end);
    // Serial.println(sub_uga);
    mySerial.println(uga);
    mySerial.println(sub_uga);
  }
}
```

vscode에서 a,random,b로 만들어서 아두이노로 보냈다.

아두이노 에서는 받은 값들을 테라텀으로 다시 보낸다.

# 난 코드를 짜는 부분에서 어려움이 있었다

또한 아두이노라는 파일 아래에 만들었더니 액세스가 불가능하다고 나왔다.

나중에 보니 이것도 문제 였지만 vc code를 실행시키면서 아두이노에 새로운 코드를 넣고 실행 시키면 돌아가지 않는다.

# 이번엔 아두이노에서 카운트해서 vscode와 tera term에서 출력하는 것을 만들어 보자

```arduino
#include <SoftwareSerial.h>
SoftwareSerial mySerial(10, 11);// Rx, Tx

void setup() {
  mySerial.begin(9600);
  Serial.begin(9600);
  // put your setup code here, to run once:
}
int count = 1;
void loop() {
Serial.print("value: ");
Serial.println(count);
mySerial.println(count);
count++;
delay(1000);
}
```

```python
import serial
import time
import random

# 시리얼 포트와 보드레이트 설정
arduino_port = 'COM5' 
baud_rate = 9600  # 아두이노와 일치하는 보드레이트 설정

# 시리얼 포트 열기
ser = serial.Serial(arduino_port, baud_rate, timeout=1)
time.sleep(2)  # 포트가 열릴 때까지 잠시 대기

while True:
    if ser.inWaiting():
        command = ser.readline()
        cmd_dec = command.decode()
        print(cmd_dec)
```

이러면 vscode와 tera term에서 출력이 된다

다음으로 보내는 딜레이를 만들어서 중간 중간에 원하는 것을 출력하게 하는 방법

```arduino
// 첫 번째 아두이노 (송신기)

#include <SoftwareSerial.h>

SoftwareSerial mySerial(10, 11); // Rx, Tx

void setup() {
  mySerial.begin(9600);
  Serial.begin(9600); // 하드웨어 시리얼 모니터 출력용
}

void loop() {
  // PC에서 아두이노 IDE 시리얼 모니터 (a90b) -> 아두이노 -> terra term (PC)
  if(Serial.available() >0){
    String uga = Serial.readStringUntil('\n');
    //Serial.println(uga);
    mySerial.println(uga);
    int start = uga.indexOf('a');
    int end = uga.indexOf('b');
    String sub_string = uga.substring(start+1, end);
    mySerial.println(sub_string);
  }
  Serial.println("hello uga");
  mySerial.println("hello uga");
  delay(300);
}
```

이걸 먼저 실행 한다음

```arduino
import serial
import time 

# 시리얼 포트 설정
port = 'COM5'  # 사용하는 시리얼 포트 이름 변경 필요
baudrate = 9600  # 보드레이트 설정
timeout = 1  # 타임아웃 설정 (초 단위)

ser = serial.Serial(port, baudrate, timeout=timeout)
count = 0

while True:
    # 보낼 문자열 설정
    message = 'a'+str(count)+'b\n'
    count+=1

    # 문자열 전송
    print(message)
    ser.write(message.encode('utf-8'))

    # 시리얼 포트 닫기
    time.sleep(1)
```

그다음 이걸 하면 tera term에 나온다.

이번엔 threading으로 양방향 관리하는 법을 알아보자

```arduino
// 첫 번째 아두이노 (송신기)

#include <SoftwareSerial.h>

SoftwareSerial mySerial(10, 11); // Rx, Tx

void setup() {
  mySerial.begin(9600);
  Serial.begin(9600); // 하드웨어 시리얼 모니터 출력용
}

void loop() {
  // PC에서 아두이노 IDE 시리얼 모니터 (a90b) -> 아두이노 -> terra term (PC)
  if(Serial.available() >0){
    String uga = Serial.readStringUntil('\n');
    //Serial.println(uga);
    mySerial.println(uga);
    int start = uga.indexOf('a');
    int end = uga.indexOf('b');
    String sub_string = uga.substring(start+1, end);
    mySerial.println(sub_string);
  }
  Serial.println("hello uga");
  mySerial.println("hello uga");
  delay(300);
}
```

여기서 hello uga라는 문자열을 받아서 Serial과 mySerial에 프린팅하는 것을 보내는 일을 한다. 또한 a(count)b 라고 받은 문자열 에서 a,b르 제거하고 중간의 숫자를 int로 바꾼다음 +1씩 하면서 출력한다.

```python
import serial
import time 
import threading

# 시리얼 포트 설정
port = 'COM5'  # 사용하는 시리얼 포트 이름 변경 필요
baudrate = 9600  # 보드레이트 설정
timeout = 1  # 타임아웃 설정 (초 단위)

ser = serial.Serial(port, baudrate, timeout=timeout)
count = 0

def receive_serial():
    while True:
        if ser.inWaiting():
            command = ser.readline()
            cmd_dec = command.decode()
            print(cmd_dec)
            time.sleep(0.05)
            
task = threading.Thread(target =receive_serial)
task.start()

while True:
    # 보낼 문자열 설정
    message = 'a'+str(count)+'b\n'
    count+=1

    # 문자열 전송
    print(message)
    ser.write(message.encode('utf-8'))

    # 시리얼 포트 닫기
    time.sleep(1)

```

여기서는 hello uga를 받아서 프린트 하고 이건 a,b사이의 숫자에 count++하면서 출력하는 것이다.

민우님이 올린 코드

```python
import serial
import time
import threading

# 시리얼 포트 설정
port = 'COM4'  # 사용하는 시리얼 포트 이름 변경 필요
baudrate = 9600  # 보드레이트 설정
timeout = 1  # 타임아웃 설정 (초 단위)

ser = serial.Serial(port, baudrate, timeout=timeout)
count = 0

def receive_serial():
    while True:
        if ser.in_waiting:
            command = ser.readline()
            cmd_dec = command.decode().strip()
            print(f"Received from Arduino: {cmd_dec}")
            time.sleep(0.05)

def send_serial():
    global count
    while True:
        # 보낼 문자열 설정
        message = f'a{count}b\n'
        count += 1

        # 문자열 전송
        print(f"Sent to Arduino: {message.strip()}")
        ser.write(message.encode('utf-8'))

        # 시리얼 포트 닫기
        time.sleep(1)

# 두 개의 쓰레드를 사용하여 송신과 수신을 동시에 수행
receive_thread = threading.Thread(target=receive_serial)
send_thread = threading.Thread(target=send_serial)

receive_thread.start()
send_thread.start()
```

다음은 아두이노 코드

```python
#include <SoftwareSerial.h>

SoftwareSerial mySerial(10, 11); // Rx, Tx

void setup() {
  mySerial.begin(9600);
  Serial.begin(9600); // 하드웨어 시리얼 모니터 출력용
  randomSeed(analogRead(0)); // 랜덤 시드 초기화
}

void loop() {
  // 랜덤 숫자 생성
  int randomNumber = random(1, 101);
  String randomString = String(randomNumber);
  mySerial.println(randomString);
  Serial.println("Sent to Python: " + randomString);

  // 파이썬에서 전송된 데이터 수신
  if (mySerial.available() > 0) {
    String received = mySerial.readStringUntil('\n');
    Serial.println("Received from Python: " + received);
    mySerial.println(received);
  }

  delay(1000); // 1초 대기
}
```

숫자를 랜덤으로 만들어서 끼워넣고

a,b사이에는 count++하는 숫자를 하나씩 올려서 출력한다.